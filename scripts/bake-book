#!/bin/sh
set -e


bookName=$1
debugFlag=$2

rawFile="./data/${bookName}-raw.html"
bakedFile="./data/${bookName}-baked.html"

# Check command line args

if [ -z "${bookName}" ]
then
  >&2 echo 'ERROR: Argument Missing. You must specify the name of the book as the 1st argument. For example: physics'
  exit 1
fi

rulesetNameAndUuid=($(./scripts/_convert-bookname-to-ruleset-name-and-uuid ${bookName}))
rulesetName=${rulesetNameAndUuid[0]}
sassFile="./books/rulesets/${rulesetName}/book.scss"
cssFile="./books/rulesets/output/${rulesetName}.css"

if [ ! -f "${rawFile}" ]
then
  >&2 echo 'ERROR: Could not find the raw HTML file. Have you run fetch-book yet?'
  exit 1
fi

if [ ! -f "${sassFile}" ]
then
  >&2 echo "ERROR: Could not find the raw SCSS file at ${sassFile}"
  exit 1
fi


>&2 echo "==> Compile SASS to CSS (${sassFile})"
bundle exec sass ${sassFile} ${cssFile}

>&2 echo "==> Baking the book (may take a couple minutes)"
>&2 echo "Specify additional commandline arguments like -d to this script if you want more debugging"
>&2 echo "Info: Baking ${rawFile} to ${bakedFile} using ${cssFile}"

# Remove the baked file if it exists
[ -e "${bakedFile}" ] && rm ${bakedFile}

# Activate the venv if not running Travis or already in a virtualenv
if [[ ! "${CI}" = "true" && -z "${VIRTUAL_ENV}" ]]
then
  source ./venv/bin/activate
fi

cnx-easybake ${DEBUG_FLAG} ${cssFile} ${RAW_PATH} ${bakedFile}

# Validate the cooked file
cnx-epub-validate-collated ${bakedFile}
