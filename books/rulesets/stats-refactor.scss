//Import order doesn't affect output
@import 'common-refactor/compose';
@import 'common-refactor/count';
@import 'common-refactor/link';
@import 'common-refactor/modify';
@import 'common-refactor/number';
@import 'common-refactor/reference';
@import 'common-refactor/utils';


//TODO: Improve performance by using more specific selectors in libraries when possible
//TODO: Separate Metadata and document-titles from composite creation mixins
//TODO: target-labels
//TODO: Numbering  book specific items (labs, try its)
//TODO: TOC
//TODO: Missing IDs, modify raw objects (wrapping, ids, target: _blank)
//TODO: URI
//TODO: Separate object files
//TODO: Misc books specific things


//TODO: write metadata retitling mixin to account for chapter-areas that are composites
//TODO: separating metadata, titling from page creation makes solutions not appear, use putSolutions to make containers
//TODO: separate initial metadata nodes() from titling??

//Different language mock-up
$lang: "en";
$chapter_en: "Chapter";
$appendix_en: "Appendix";
$chapter_de: "Kapitel";
$appendix_de: "Anhang";

//Base object to be inherited
$compositePage_obj: (
  name: null,
  source: null,
  sectionSeparated: false,
  compoundComposite: false
);

//Inherit compositePage object
@function compositePage($params) {
  @return map-merge($compositePage_obj, $params);
}

$compositePageChapter_obj: compositePage((
  hasSolutions: false,
  isGlossary: false,
  sortBy: null,
));

@function chapterComposite($params) {
  @return map-merge($compositePageChapter_obj, $params);
}

$compositePageBook_obj: compositePage((
  chapterSeparated: false,
  chapterPages: false,
  isIndex: false,
));

@function bookComposite($params) {
  @return map-merge($compositePageBook_obj, $params);
}

// object keys can be overriden per book:
// $compositePage_obj: map-merge($compositePage_obj,
//   (nameClass: "text")
// );

$pageKeyTerms: chapterComposite((
  name: "Key Terms",
  source: "glossary",
  isGlossary: true,
  sortBy: "dl > dt"
));

$pageChapterReview: chapterComposite((
  name: "Chapter Review",
  source: "summary",
  sectionSeparated: true
));

$pageFormulaReview: chapterComposite((
  name: "Formula Review",
  source: "formula-review",
  sectionSeparated: true
));

$pagePractice: chapterComposite((
  name: "Practice",
  source: "practice",
  sectionSeparated: true,
  hasSolutions: true
));

$pageBITExercises: chapterComposite((
  name: "Bringing It Together: Exercises",
  source: "bring-together-exercises",
  hasSolutions: true
));

$pageHomework: chapterComposite((
  name: "Homework",
  source: "free-response",
  sectionSeparated: true,
  hasSolutions: true
));

$pageBITHomework: chapterComposite((
  name: "Bringing It Together: Homework",
  source: "bring-together-homework",
  hasSolutions: true
));

$pageReferences: chapterComposite((
  name: "References",
  source: "references",
  sectionSeparated: true
));

$pageSolutions: chapterComposite((
  name: "Solutions",
  source: "solutions",
  compoundComposite: true
));

$chapterCompositePages: (
  $pageKeyTerms,
  $pageChapterReview,
  $pageFormulaReview,
  $pagePractice,
  $pageBITExercises,
  $pageHomework,
  $pageBITHomework,
  $pageReferences,
  $pageSolutions
);

$pageIndex: bookComposite((
  name: "Index",
  source: "index",
  isIndex: true
));

$bookCompositePages: (
  //This doesn't get parsed as a list without a comma at the end, the composite builder must account for this
  $pageIndex,
);

//make content maps
//unfortunately a base obj cannot be created for all Content because it would make the order of the keys static
//when they need to be able to be in any order because of possible changes in titling order between books
$chapterTitleContent: (
  label: "Chapter",
  number: counter(chapter),
  divider: "|"
);

$appendixTitleContent: (
  label: "Appendix",
  number: counter(appendix, upper-alpha),
  divider: ":"
);

$sectionTitleContent: (
  number: counter(chapter)"."counter(section),
  divider: "|"
);

$exerciseTitleContent: (
  number: counter(exercise)
);

$exampleTitleContent: (
  label: "Example",
  number: counter(chapter)"."counter(example)
);

$exampleSolutionTitleContent: (
  label: "Solution",
  number: counter(chapter)"."counter(example)
);

<<<<<<< 810d85ac1a9d0d372375ede48feba1f38afa0dd2
$captionTableNumber: (
  label: "Table.",
  number: counter(chapter)"."counter(table)
);

$setTableCaption: (
  type: table,
  defaultContainer: caption,
  hasCaption: false,
  hasTitle: true
);

$captionFigNumber: (
  label: "Figure.",
  number: counter(chapter)"."counter(figure)
);

$setFigureCaption: (
   type: figure,
  defaultContainer: figcaption,
   hasCaption: true,
  hasTitle: false
);

=======
>>>>>>> Sort out problems with page titling and empty containers, document dependencies on the book level, add capability to separate EOB sections into chapter separated composite pages
//New pass system
:pass(0) {
  //Possibly not needed later
  @include titlePreface();
  //Come up with mixins for common numbering schemes as per Phil's suggestion
  @include countChapters(chapter);
  @include numberChapters($chapterTitleContent);
  @include countAppendices(appendix);
  @include numberAppendices($appendixTitleContent);
  @include countSections(section);
  @include numberSections($sectionTitleContent);
  @include countExamples(example);
  @include numberExamples($exampleTitleContent, $exampleSolutionTitleContent);

  @include countTerms(term);
  @include refPageIDStringAs(pageID);
  @include prepIndexTerms(term, pageID);

  @include refSectionHeaderNodeAs(sectionHeaderNode);
  @include createChapterComposites($chapterCompositePages, sectionHeaderNode);
}
:pass(1) {
  //After: ???
  @include refSectionHeaderNodeAs(sectionHeaderNode);
  @include refSectionHeaderStringAs(sectionHeaderString);
  @include prepBookComposites($bookCompositePages, sectionHeaderNode, sectionHeaderString);

  //After: createChapterComposites
  @include countEOCExercises(exercise);
  @include numberEOCExercises($exerciseTitleContent, $exerciseTitleContent);
}
:pass(2) {
  //After: createChapterComposites, numberEOCExercises
  @include countEOCExercises(exercise);
  @include linkToProblemsFromSolutionsEOC("number", "number", exercise);

  //After: prepBookComposites
  @include refChapterHeaderNodeAs(chapterHeaderNode);
  @include prepChapterAreas($bookCompositePages, chapterHeaderNode);

}
:pass(3) {
  //Only move solutions after exercises/solutions are numbered
  @include createEOCSolutions($chapterCompositePages, $pageSolutions, sectionHeaderNode);

  //After: prepBookComposites, prepChapterAreas
  @include refChapterHeaderNodeAs(chapterHeaderNode);
  @include createBookComposites($bookCompositePages);
}
:pass(4) {
  //After: prepIndexTerms, createBookComposites
  @include addIndexSymbolGroup("index", "Symbols");

  //After: createChapterComposites, createEOCSolutions, createBookComposites
  @include titleEOCComposites($chapterCompositePages);
  @include titleEOBComposites($bookCompositePages);

  @include countFigTables(table);
  @include countFigTables(figure);
  @include setCaptions($setTableCaption, $captionTableNumber);
  @include setCaptions($setFigureCaption, $captionFigNumber);
}
:pass(100) {
  @include clearTrash();
}