//Import order doesn't affect output
@import 'common-refactor/compose';
@import 'common-refactor/count';
@import 'common-refactor/link';
@import 'common-refactor/modify';
@import 'common-refactor/number';
@import 'common-refactor/reference';
@import 'common-refactor/toc';
@import 'common-refactor/utils';

//TODO: Improve performance by using more specific selectors in libraries when possible
//TODO: Separate object files
//TODO: Make sure mixins are "namespaced" to the file they are from

//Different language mock-up
$lang: "en";
$chapter_en: "Chapter";
$appendix_en: "Appendix";
$chapter_de: "Kapitel";
$appendix_de: "Anhang";

//Base object to be inherited
$compositePage_obj: (
  name: null,
  source: null,
  sectionSeparated: false,
  compoundComposite: false
);

//Inherit compositePage object
@function compositePage($params) {
  @return map-merge($compositePage_obj, $params);
}

$compositePageChapter_obj: compositePage((
  hasSolutions: false,
  isGlossary: false,
  sortBy: null,
));

@function chapterComposite($params) {
  @return map-merge($compositePageChapter_obj, $params);
}

$compositePageBook_obj: compositePage((
  chapterSeparated: false,
  chapterPages: false,
  isIndex: false,
));

@function bookComposite($params) {
  @return map-merge($compositePageBook_obj, $params);
}

// object keys can be overriden per book:
// $compositePage_obj: map-merge($compositePage_obj,
//   (nameClass: "text")
// );

$pageKeyTerms: chapterComposite((
  name: "Key Terms",
  source: "glossary",
  isGlossary: true,
  sortBy: "dl > dt"
));

$pageChapterReview: chapterComposite((
  name: "Chapter Review",
  source: "summary",
  sectionSeparated: true
));

$pageFormulaReview: chapterComposite((
  name: "Formula Review",
  source: "formula-review",
  sectionSeparated: true
));

$pagePractice: chapterComposite((
  name: "Practice",
  source: "practice",
  sectionSeparated: true,
  hasSolutions: true
));

$pageBITExercises: chapterComposite((
  name: "Bringing It Together: Exercises",
  source: "bring-together-exercises",
  hasSolutions: true
));

$pageHomework: chapterComposite((
  name: "Homework",
  source: "free-response",
  sectionSeparated: true,
  hasSolutions: true
));

$pageBITHomework: chapterComposite((
  name: "Bringing It Together: Homework",
  source: "bring-together-homework",
  hasSolutions: true
));

$pageReferences: chapterComposite((
  name: "References",
  source: "references",
  sectionSeparated: true
));

$pageSolutions: chapterComposite((
  name: "Solutions",
  source: "solutions",
  compoundComposite: true
));

$chapterCompositePages: (
  $pageKeyTerms,
  $pageChapterReview,
  $pageFormulaReview,
  $pagePractice,
  $pageBITExercises,
  $pageHomework,
  $pageBITHomework,
  $pageReferences,
  $pageSolutions
);

$pageIndex: bookComposite((
  name: "Index",
  source: "index",
  isIndex: true
));

$bookCompositePages: (
  //This doesn't get parsed as a list without a comma at the end, the composite builder must account for this
  $pageIndex,
);

//make content maps
//unfortunately a base obj cannot be created for all Content because it would make the order of the keys static
//when they need to be able to be in any order because of possible changes in titling order between books
$chapterTitleContent: (
  title-label: "Chapter ",
  number: counter(chapter),
  divider: " | "
);

$appendixTitleContent: (
  title-label: "Appendix ",
  number: counter(appendix, upper-alpha),
  divider: " : "
);

$sectionTitleContent: (
  number: counter(chapter) "." counter(section),
  divider: " | "
);

$exerciseTitleContent: (
  number: counter(exercise)
);

$exampleTitleContent: (
  title-label: "Example ",
  number: counter(chapter) "." counter(example)
);

$exampleSolutionTitleContent: (
  title-label: "Solution ",
  number: counter(chapter) "." counter(example)
);

$tryTitleContent: (
  title-label: "Try It ",
  number: counter(chapter) "." counter(example)
);

$calcTitleContent: (
  title-label: "Using the TI-83, 83+, 84, 84+ Calculator"
);

$captionTableNumber: (
  title-label: "Table ",
  number: counter(chapter) "." counter(table)
);

//TODO: Make a counter for both chapter and appendix, and automate the switch between standard and upper alpha counting?
$captionTableNumberAp: (
  title-label: "Table ",
  number: counter(appendix, upper-alpha) "." counter(table)
);

$setTableCaption: (
  type: table,
  defaultContainer: caption,
  hasCaption: false,
  hasTitle: true
);

$captionFigNumber: (
  title-label: "Figure ",
  number: counter(chapter) "." counter(figure)
);

//TODO: Make a counter for both chapter and appendix, and automate the switch between standard and upper alpha counting?
$captionFigNumberAp: (
  title-label: "Figure ",
  number: counter(appendix, upper-alpha) "." counter(figure)
);

$setFigureCaption: (
  type: figure,
  defaultContainer: figcaption,
  hasCaption: true,
  hasTitle: false
);

//If this method of setting the content of the label explicity becomes a problem,
//try grabbing the numbering information from the element's header

//NOTE: These selectors MUST match the counting selectors or be more specific
//otherwise, the increment and the counter() call may fire in the wrong order
//This may be fixed in a later version of easybake
$targetLabels: (
  (
    selector: '.eoc [data-type="exercise"]',
    label: "Exercise " counter(chapter) "." counter(exercise)
  )
  (
    selector: 'div[data-type="chapter"] .example',
    label: "Example " counter(chapter) "." counter(example)
  )
  (
    selector: 'div[data-type="chapter"] .try',
    label: "Try It"
  )
  (
    selector: '[data-type="chapter"] :not(table) > table',
    label: "Table " counter(chapter) "." counter(table)
  )
  (
    selector: '[data-type="chapter"] :not(figure) > figure',
    label: "Figure " counter(chapter) "." counter(figure)
  )
  (
    selector: '[data-type="appendix"] :not(table) > table',
    label: "Table " counter(appendix, upper-alpha) "." counter(table)
  )
  (
    selector: '[data-type="appendix"] :not(figure) > figure',
    label: "Table " counter(appendix, upper-alpha) "." counter(figure)
  )
);

//New pass system
:pass(0) {
  //Some modifications to be done to the book before any collation
  @include titlePreface();
  @include spanWrapTitles();
  @include simLinkTarget();
  @include trash('.try [data-type="solution"]');
}
:pass(1) {
  //Come up with mixins for common numbering schemes as per Phil's suggestion
  @include countChapters(chapter);
  @include numberChapters($chapterTitleContent);
  @include countAppendices(appendix);
  @include numberAppendices($appendixTitleContent);
  @include countSections(section);
  @include numberSections($sectionTitleContent);
  @include countExamples(example);
  @include numberExamples($exampleTitleContent, $exampleSolutionTitleContent);
  @include countNote(Try, "try");
  @include numberNote("try", $tryTitleContent);
  @include numberNote("calculator", $calcTitleContent);

  //If this is after spanWrapTitles, we get a bunch of "Unknown term <IdentToken none>" warnings from easybake??'
  //I'm not sure spanWrapTitles is necessarily the cause though, it's happened without it before
  @include countTerms(term);
  @include refPageIDStringAs(pageID);
  @include prepIndexTerms(term, pageID);

  @include refSectionHeaderNodeAs(sectionHeaderNode);
  @include createChapterComposites($chapterCompositePages, sectionHeaderNode);
}
:pass(2) {
  //After: ???
  @include refSectionHeaderNodeAs
  (sectionHeaderNode);
  @include refSectionHeaderStringAs(sectionHeaderString);
  @include prepBookComposites($bookCompositePages, sectionHeaderNode, sectionHeaderString);

  //After: createChapterComposites
  @include countEOCExercises(exercise);
  @include numberEOCExercises($exerciseTitleContent, $exerciseTitleContent);
}
:pass(3) {
  //After: createChapterComposites, numberEOCExercises
  @include countExercises(exerciseAll);
  @include linkToProblemsFromSolutionsEOC("number", "number", exerciseAll);

  //After: prepBookComposites
  @include refChapterHeaderNodeAs(chapterHeaderNode);
  @include prepChapterAreas($bookCompositePages, chapterHeaderNode);

}
:pass(4) {
  //Only move solutions after exercises/solutions are numbered
  @include createEOCSolutions($chapterCompositePages, $pageSolutions, sectionHeaderNode);

  //After: prepBookComposites, prepChapterAreas
  @include createBookComposites($bookCompositePages);
}
:pass(5) {
  //After: prepIndexTerms, createBookComposites
  @include addIndexSymbolGroup("index", "Symbols");

  //After: composite page creation
  @include countChapters(chapter);
  @include countAppendices(appendix);
  @include countTables(table);
  @include countFigures(figure);
  @include countEOCExercises(exercise);
  @include countExamples(example);
  @include setTargetLabels($targetLabels);
  @include setLinkLabels();

  @include refBookMetadataNodeAs(bookMetadata);
  @include compositeMetadata(bookMetadata);

  //After: createChapterComposites, createEOCSolutions, createBookComposites
  @include titleEOCComposites($chapterCompositePages);
  @include titleEOBComposites($bookCompositePages);

  @include compositeAutoID();
  @include chapterAutoID();

  @include countTables(table);
  @include countFigures(figure);
  @include setCaptions($setTableCaption, $captionTableNumber, $captionTableNumberAp);
  @include setCaptions($setFigureCaption, $captionFigNumber, $captionFigNumberAp);
}
:pass(6) {
  @include retitleCompositeMetadata();
}
:pass(7) {
  //After: All metadata tasks are completed
  @include suppressURI();

  @include prepTOCElements();
}
:pass(8) {
  @include putTOCElements();
}
:pass(9) {
  @include navTOCUnwrap();
}
:pass(100) {
  @include clearTrash();
}